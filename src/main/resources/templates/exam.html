<!doctype html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Wszystkie pytania â€“ Java Quiz</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            padding: 30px;
        }

        h1 {
            margin-bottom: 10px;
        }

        .controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .controls button {
            margin-right: 10px;
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .filter {
            background: #d32f2f;
            color: white;
        }

        .reset {
            background: #1976d2;
            color: white;
        }

        .question {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .meta {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 12px;
        }

        .answers button {
            display: block;
            width: 100%;
            margin: 6px 0;
            padding: 10px;
            border-radius: 6px;
            border: 2px solid #ccc;
            cursor: pointer;
            background: white;
        }

        .correct {
            border: 3px solid green !important;
            background: #e8f5e9;
        }

        .wrong {
            border: 3px solid red !important;
            background: #fdecea;
        }

        .selected {
            border: 3px solid #999 !important;
            background: #eeeeee;
        }

        a.back {
            display: inline-block;
            margin-bottom: 20px;
            text-decoration: none;
            font-weight: bold;
            color: #1976d2;
        }

        .back {
            position: fixed;
            top: 20px;
            left: 20px;
            text-decoration: none;
            font-weight: bold;
            color: #1976d2;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .quiz-container {
            display: flex;
            justify-content: center;
            margin-top: 80px; /* Å¼eby nie nachodziÅ‚o na przycisk */
        }
    </style>
</head>

<body>

<a class="back" th:href="@{/}">â¬… PowrÃ³t do menu</a>

<h1>ðŸ“š Egzamin</h1>

<div th:if="${session.LOGIN == null}">
    <h3>ðŸ‘¤ Podaj login</h3>

    <form method="post" th:action="@{/exam/start}">
        <input
                name="login"
                placeholder="TwÃ³j login"
                required
                type="text"
        />
        <br><br>
        <button type="submit">â–¶ Start</button>
    </form>
</div>

<!-- ===== PANEL ===== -->
<div class="controls">
    <strong>OgÃ³Å‚em:</strong> <span id="correctCount">0</span> |
    <strong>BÅ‚Ä™dne:</strong> <span id="wrongCount">0</span>

    <br><br>

    <div style="margin-bottom:20px;" th:if="${session.LOGIN != null}">
        <span>ðŸ‘¤ <b th:text="${session.LOGIN}"></b></span>
        |
        <a style="color:red; font-weight:bold;" th:href="@{/exam/logout}">
            ðŸšª Wyloguj
        </a>
    </div>
    <button class="filter" onclick="showOnlyWrong()">ðŸ§¹ PokaÅ¼ tylko bÅ‚Ä™dne pytania</button>
    <button class="reset" onclick="resetView()">ðŸ”„ Reset</button>
    <button class="reset" onclick="reroll()">ðŸŽ² Losuj ponownie</button>
    <button onclick="finishQuiz()">âœ… ZakoÅ„cz quiz</button>
</div>

<!-- ===== PYTANIA ===== -->
<div th:if="${session.LOGIN != null}">
    <div class="question" th:data-question-id="${q.id}" th:each="q, qi : ${questions}">

        <h3 th:text="${q.text}"></h3>

        <div class="meta">
            Poziom: <span th:text="${q.advancement}"></span> |
            Kategoria: <span th:text="${q.category}"></span>
        </div>

        <div class="answers">
            <button
                    onclick="checkAnswer(this)"
                    th:data-answer-id="${ai.index + 1}"
                    th:data-correct="${a.correct}"
                    th:each="a, ai : ${q.answers}"
                    th:text="${a.text}">
            </button>
        </div>

    </div>

</div>


<!-- ===== JS ===== -->
<script>
    function sendResults(data) {
        fetch('/exam/finish', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(() => {
            window.location.href = '/';
        });
    }

    function checkAnswer(button) {
        const answers = button.closest('.answers')
            .querySelectorAll('button');

        // 1ï¸âƒ£ reset stanu
        answers.forEach(btn => {
            btn.dataset.selected = "false";
            btn.classList.remove('correct', 'wrong');
            btn.disabled = true;
        });

        // 2ï¸âƒ£ zaznacz klikniÄ™tÄ…
        button.dataset.selected = "true";

        // 3ï¸âƒ£ ZAWSZE podÅ›wietl poprawnÄ… odpowiedÅº
        answers.forEach(btn => {
            if (btn.dataset.correct === "true") {
                btn.classList.add('correct');
            }
        });

        // 4ï¸âƒ£ jeÅ›li klikniÄ™ta jest bÅ‚Ä™dna â†’ zaznacz jÄ… na czerwono
        if (button.dataset.correct !== "true") {
            button.classList.add('wrong');
        }
    }


    function finishQuiz() {

        const result = [];

        document.querySelectorAll('.question').forEach(q => {

            const questionId = Number(q.dataset.questionId);
            const selected = q.querySelector('button[data-selected="true"]');

            if (!selected) return;


            result.push({
                questionId: questionId,
                selectedAnswer: Number(selected.dataset.answerId),
                correct: selected.dataset.correct === "true"
            });
        });

        sendResults(result);
    }


    function showOnlyWrong() {
        document.querySelectorAll('.question').forEach(q => {
            const wrongSelected = q.querySelector('.selected');
            if (!wrongSelected) {
                q.style.display = 'none';
            }
        });
    }

    function resetView() {
        document.querySelectorAll('.question').forEach(q => {
            q.style.display = 'block';

            q.querySelectorAll('button').forEach(b => {
                b.className = '';
                b.disabled = false;
            });
        });

        document.getElementById('correctCount').innerText = 0;
        document.getElementById('wrongCount').innerText = 0;
    }

    function reroll() {
        window.location.reload();
    }
</script>

</body>
</html>
